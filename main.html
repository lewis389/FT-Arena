<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fight Trade — Arena · Trade · Stratagem</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Share+Tech+Mono&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg-deep: #0a0c0f;
      --bg-panel: #12161c;
      --bg-elevated: #1a1f28;
      --border: #2a3340;
      --accent-trade: #e8b84a;
      --accent-battle: #c94b4b;
      --accent-strat: #4bc97a;
      --text: #e2e6ec;
      --text-dim: #7d8796;
      --glow-trade: rgba(232, 184, 74, 0.25);
      --glow-battle: rgba(201, 75, 75, 0.25);
      --glow-strat: rgba(75, 201, 122, 0.2);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-deep);
      color: var(--text);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 120% 80% at 50% -20%, rgba(40,50,70,0.4), transparent),
                        linear-gradient(180deg, var(--bg-deep) 0%, #0d1117 100%);
    }
    .app-wrap { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }
    header.ft-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .ft-logo {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1.75rem;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, var(--accent-trade), var(--accent-battle));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .ft-tagline { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--text-dim); margin-top: 0.2rem; }
    .ft-connect {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .ft-connect .addr {
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.85rem;
      color: var(--accent-strat);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ft-btn {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text);
      cursor: pointer;
      border-radius: 4px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .ft-btn:hover { border-color: var(--accent-trade); box-shadow: 0 0 12px var(--glow-trade); }
    .ft-btn.primary { background: linear-gradient(135deg, #2a3a1a, #1a2a12); border-color: var(--accent-strat); color: var(--accent-strat); }
    .ft-btn.primary:hover { box-shadow: 0 0 14px var(--glow-strat); }
    .ft-btn.danger { border-color: var(--accent-battle); color: var(--accent-battle); }
    .ft-btn.danger:hover { box-shadow: 0 0 12px var(--glow-battle); }
    .ft-tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }
    .ft-tab {
      padding: 0.7rem 1.2rem;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .ft-tab:hover { color: var(--text); border-color: var(--text-dim); }
    .ft-tab.active { background: var(--bg-elevated); color: var(--accent-trade); border-color: var(--accent-trade); box-shadow: 0 0 12px var(--glow-trade); }
    .ft-panel { display: none; }
    .ft-panel.visible { display: block; }
    .ft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 900px) { .ft-grid { grid-template-columns: 1fr; } }
    .ft-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .ft-card h3 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    .ft-card.trade h3 { color: var(--accent-trade); }
    .ft-card.battle h3 { color: var(--accent-battle); }
    .ft-card.strat h3 { color: var(--accent-strat); }
    .ft-label { display: block; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 0.35rem; }
    .ft-input, .ft-select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.9rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      margin-bottom: 0.75rem;
    }
    .ft-input:focus, .ft-select:focus { outline: none; border-color: var(--accent-trade); }
    .ft-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
    .ft-list { list-style: none; }
    .ft-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .ft-list li:last-child { border-bottom: none; }
    .ft-list .mono { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--text-dim); }
    .ft-stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .ft-stat { font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; }
    .ft-stat strong { color: var(--accent-trade); margin-right: 0.25rem; }
    .ft-territory-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }
    .ft-territory-cell {
      aspect-ratio: 1;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .ft-territory-cell:hover { border-color: var(--accent-strat); box-shadow: 0 0 8px var(--glow-strat); }
    .ft-territory-cell.selected { border-color: var(--accent-strat); background: rgba(75,201,122,0.1); color: var(--accent-strat); }
    .ft-msg { padding: 0.75rem; border-radius: 4px; margin-top: 0.75rem; font-size: 0.9rem; }
    .ft-msg.ok { background: rgba(75,201,122,0.15); border: 1px solid var(--accent-strat); color: var(--accent-strat); }
    .ft-msg.err { background: rgba(201,75,75,0.15); border: 1px solid var(--accent-battle); color: var(--accent-battle); }
    .ft-msg.info { background: rgba(232,184,74,0.1); border: 1px solid var(--accent-trade); color: var(--accent-trade); }
  </style>
</head>
<body>
  <div class="app-wrap">
    <header class="ft-header">
      <div>
        <div class="ft-logo">FIGHT TRADE</div>
        <p class="ft-tagline">Arena · Trade · Stratagem — Vexel protocol</p>
      </div>
      <div class="ft-connect">
        <input type="text" id="contract-address" class="ft-input" placeholder="Contract 0x..." style="width:220px; margin:0;" title="Deployed FightTradeVexel address" />
        <span class="addr" id="wallet-addr">—</span>
        <button type="button" class="ft-btn primary" id="btn-connect">Connect</button>
      </div>
    </header>

    <div class="ft-stats-bar" id="stats-bar">
      <span class="ft-stat"><strong>Credits</strong> <span id="stat-credits">0</span></span>
      <span class="ft-stat"><strong>Level</strong> <span id="stat-level">0</span></span>
      <span class="ft-stat"><strong>Orders</strong> <span id="stat-orders">0</span></span>
      <span class="ft-stat"><strong>Season</strong> <span id="stat-season">1</span></span>
    </div>

    <nav class="ft-tabs">
      <button type="button" class="ft-tab active" data-tab="trade">Trade</button>
      <button type="button" class="ft-tab" data-tab="battle">Battle</button>
      <button type="button" class="ft-tab" data-tab="strategy">Strategy</button>
    </nav>

    <section id="panel-trade" class="ft-panel visible">
      <div class="ft-grid">
        <div class="ft-card trade">
          <h3>Credits & Orders</h3>
          <label class="ft-label">Deposit (ETH)</label>
          <input type="text" id="deposit-amount" class="ft-input" placeholder="0.01" />
          <label class="ft-label">Referrer (optional)</label>
          <input type="text" id="referrer-addr" class="ft-input" placeholder="0x..." />
          <div class="ft-actions">
            <button type="button" class="ft-btn primary" id="btn-deposit">Deposit</button>
            <button type="button" class="ft-btn" id="btn-withdraw">Withdraw</button>
          </div>
          <div id="trade-msg" class="ft-msg" style="display:none;"></div>
        </div>
        <div class="ft-card trade">
          <h3>Place Order</h3>
          <label class="ft-label">Amount (wei scale)</label>
          <input type="text" id="order-amount" class="ft-input" placeholder="1000000000000000" />
          <label class="ft-label">Price (bps 1-10000)</label>
          <input type="text" id="order-price" class="ft-input" placeholder="5000" />
          <label class="ft-label">Resource</label>
          <select id="order-resource" class="ft-select">
            <option value="GOLD">GOLD</option>
            <option value="ORE">ORE</option>
            <option value="GRAIN">GRAIN</option>
            <option value="WOOD">WOOD</option>
          </select>
          <label class="ft-label">Side</label>
          <select id="order-side" class="ft-select">
            <option value="true">Buy</option>
            <option value="false">Sell</option>
          </select>
          <div class="ft-actions">
            <button type="button" class="ft-btn primary" id="btn-place-order">Place Order</button>
          </div>
        </div>
        <div class="ft-card trade" style="grid-column: 1 / -1;">
          <h3>Order Book (recent)</h3>
          <ul class="ft-list" id="order-list">
            <li class="mono">Connect and set contract address to load orders.</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="panel-battle" class="ft-panel">
      <div class="ft-grid">
        <div class="ft-card battle">
          <h3>Open Battle</h3>
          <label class="ft-label">Defender address</label>
          <input type="text" id="battle-defender" class="ft-input" placeholder="0x..." />
          <label class="ft-label">Stake (wei, min 1e16)</label>
          <input type="text" id="battle-stake" class="ft-input" placeholder="10000000000000000" />
          <div class="ft-actions">
            <button type="button" class="ft-btn danger" id="btn-open-battle">Challenge</button>
          </div>
          <div id="battle-msg" class="ft-msg" style="display:none;"></div>
        </div>
        <div class="ft-card battle">
          <h3>Commit / Reveal</h3>
          <label class="ft-label">Battle ID</label>
          <input type="text" id="battle-id" class="ft-input" placeholder="1" />
          <label class="ft-label">Commit hash (hex)</label>
          <input type="text" id="battle-commit" class="ft-input" placeholder="0x..." />
          <div class="ft-actions">
            <button type="button" class="ft-btn" id="btn-commit">Commit</button>
          </div>
          <label class="ft-label">Reveal: Challenger nonce (hex)</label>
          <input type="text" id="reveal-challenger" class="ft-input" placeholder="0x..." />
          <label class="ft-label">Defender nonce (hex)</label>
          <input type="text" id="reveal-defender" class="ft-input" placeholder="0x..." />
          <div class="ft-actions">
            <button type="button" class="ft-btn danger" id="btn-reveal">Reveal & Resolve</button>
          </div>
        </div>
        <div class="ft-card battle" style="grid-column: 1 / -1;">
          <h3>Battles</h3>
          <ul class="ft-list" id="battle-list">
            <li class="mono">Open a battle or connect to see list.</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="panel-strategy" class="ft-panel">
      <div class="ft-grid">
        <div class="ft-card strat">
          <h3>Execute Stratagem</h3>
          <label class="ft-label">Territory ID (0–63)</label>
          <input type="number" id="strat-territory" class="ft-input" min="0" max="63" value="0" />
          <label class="ft-label">Unit count (1–255)</label>
          <input type="number" id="strat-units" class="ft-input" min="1" max="255" value="10" />
          <label class="ft-label">Move hash (hex)</label>
          <input type="text" id="strat-hash" class="ft-input" placeholder="0x..." />
          <div class="ft-actions">
            <button type="button" class="ft-btn primary" id="btn-stratagem">Execute</button>
          </div>
          <div id="strat-msg" class="ft-msg" style="display:none;"></div>
        </div>
        <div class="ft-card strat">
          <h3>Territories</h3>
          <div class="ft-territory-grid" id="territory-grid">
            <!-- 64 cells 0..63 -->
          </div>
          <p class="ft-label" style="margin-top:0.75rem;">Click a cell to select for stratagem.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function() {
      const CONTRACT_ADDRESS_KEY = 'fightTrade_contractAddress';
      const defaultContractAddress = '0x0000000000000000000000000000000000000000';

      const VEXEL_ABI = [
        'function depositCredits(address referrer) payable',
        'function withdrawCredits(uint256 amountWei)',
        'function placeOrder(uint256 amountWei, uint256 priceBps, bytes32 resourceId, bool isBuy) returns (uint256)',
        'function fillOrder(uint256 orderId, uint256 takeAmountWei)',
        'function cancelOrder(uint256 orderId)',
        'function openBattle(address defender, uint256 stakeWei) returns (uint256)',
        'function commitBattle(uint256 battleId, bytes32 commitHash)',
        'function revealBattle(uint256 battleId, bytes32 moveNonceChallenger, bytes32 moveNonceDefender)',
        'function executeStratagem(uint256 territoryId, uint256 unitCount, bytes32 moveHash) returns (uint256)',
        'function vexelCredits(address) view returns (uint256)',
        'function userLevel(address) view returns (uint256)',
        'function userExperience(address) view returns (uint256)',
        'function orderNonce() view returns (uint256)',
        'function currentSeasonId() view returns (uint256)',
        'function getMakerOrderIds(address) view returns (uint256[])',
        'function getOrder(uint256) view returns (address,uint256,uint256,uint256,bytes32,bool,bool)',
        'function getBattle(uint256) view returns (address,address,uint256,uint256,bytes32,bytes32,uint8,address)',
        'function getAccountStats(address) view returns (uint256,uint256,uint256,uint256,address)',
        'function battleNonce() view returns (uint256)'
      ];

      let provider = null;
      let signer = null;
      let contract = null;
      let contractAddress = localStorage.getItem(CONTRACT_ADDRESS_KEY) || defaultContractAddress;
      const contractInput = document.getElementById('contract-address');
      if (contractInput) {
        contractInput.value = contractAddress;
        contractInput.addEventListener('change', () => {
          const v = contractInput.value.trim();
          if (ethers.isAddress(v)) {
            contractAddress = v;
            localStorage.setItem(CONTRACT_ADDRESS_KEY, v);
            if (signer) contract = new ethers.Contract(contractAddress, VEXEL_ABI, signer);
            refreshStats();
          }
        });
      }

      function showMsg(panelId, text, type) {
        const el = document.getElementById(panelId);
        if (!el) return;
        el.textContent = text;
        el.className = 'ft-msg ' + (type || 'info');
        el.style.display = 'block';
      }

      function hideMsg(panelId) {
        const el = document.getElementById(panelId);
        if (el) { el.style.display = 'none'; }
      }

      function resourceToBytes32(name) {
        const hex = '0x' + Array.from(name).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
        return ethers.zeroPadValue(hex, 32);
      }

      async function connect() {
        try {
          provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send('eth_requestAccounts', []);
          signer = await provider.getSigner();
          const addr = await signer.getAddress();
          document.getElementById('wallet-addr').textContent = addr.slice(0, 6) + '…' + addr.slice(-4);
          const addrContract = contractInput && ethers.isAddress(contractInput.value.trim()) ? contractInput.value.trim() : contractAddress;
          if (addrContract !== defaultContractAddress) {
            contractAddress = addrContract;
            contract = new ethers.Contract(contractAddress, VEXEL_ABI, signer);
            await refreshStats();
          }
        } catch (e) {
          showMsg('trade-msg', 'Connect failed: ' + (e.message || e), 'err');
        }
      }

      async function refreshStats() {
        if (!contract || !signer) return;
        try {
          const addr = await signer.getAddress();
          const [credits, level, xp, orderCount] = await contract.getAccountStats(addr);
          document.getElementById('stat-credits').textContent = ethers.formatEther(credits);
          document.getElementById('stat-level').textContent = level.toString();
          document.getElementById('stat-orders').textContent = orderCount.toString();
          const season = await contract.currentSeasonId();
          document.getElementById('stat-season').textContent = season.toString();
        } catch (_) {}
      }

      document.getElementById('btn-connect').addEventListener('click', connect);

      document.querySelectorAll('.ft-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.ft-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.ft-panel').forEach(p => p.classList.remove('visible'));
          tab.classList.add('active');
          const id = 'panel-' + tab.dataset.tab;
          const panel = document.getElementById(id);
          if (panel) panel.classList.add('visible');
        });
      });

      document.getElementById('btn-deposit').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('trade-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('trade-msg');
        const amount = document.getElementById('deposit-amount').value;
        const referrer = document.getElementById('referrer-addr').value.trim();
        try {
          const ref = referrer && ethers.isAddress(referrer) ? referrer : ethers.ZeroAddress;
          const tx = await contract.depositCredits(ref, { value: ethers.parseEther(amount || '0') });
          await tx.wait();
          showMsg('trade-msg', 'Deposit confirmed.', 'ok');
          refreshStats();
        } catch (e) { showMsg('trade-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-withdraw').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('trade-msg', 'Connect wallet and set contract.', 'err'); return; }
        const amount = document.getElementById('deposit-amount').value;
        if (!amount) { showMsg('trade-msg', 'Enter amount to withdraw.', 'err'); return; }
        hideMsg('trade-msg');
        try {
          const tx = await contract.withdrawCredits(ethers.parseEther(amount));
          await tx.wait();
          showMsg('trade-msg', 'Withdraw confirmed.', 'ok');
          refreshStats();
        } catch (e) { showMsg('trade-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-place-order').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('trade-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('trade-msg');
        const amount = document.getElementById('order-amount').value;
        const price = document.getElementById('order-price').value;
        const resource = document.getElementById('order-resource').value;
        const isBuy = document.getElementById('order-side').value === 'true';
        try {
          const resourceId = ethers.keccak256(ethers.toUtf8Bytes(resource));
          const tx = await contract.placeOrder(amount, price, resourceId, isBuy);
          const rec = await tx.wait();
          showMsg('trade-msg', 'Order placed. Tx: ' + rec.hash.slice(0, 10) + '…', 'ok');
          refreshStats();
        } catch (e) { showMsg('trade-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-open-battle').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('battle-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('battle-msg');
        const defender = document.getElementById('battle-defender').value.trim();
        const stake = document.getElementById('battle-stake').value;
        if (!ethers.isAddress(defender)) { showMsg('battle-msg', 'Invalid defender address.', 'err'); return; }
        try {
          const tx = await contract.openBattle(defender, stake);
          const rec = await tx.wait();
          showMsg('battle-msg', 'Battle opened. Tx: ' + rec.hash.slice(0, 10) + '…', 'ok');
          refreshStats();
        } catch (e) { showMsg('battle-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-commit').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('battle-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('battle-msg');
        const battleId = document.getElementById('battle-id').value;
        const commitHash = document.getElementById('battle-commit').value;
        try {
          const tx = await contract.commitBattle(battleId, commitHash);
          await tx.wait();
          showMsg('battle-msg', 'Commit recorded.', 'ok');
        } catch (e) { showMsg('battle-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-reveal').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('battle-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('battle-msg');
        const battleId = document.getElementById('battle-id').value;
        const c = document.getElementById('reveal-challenger').value;
        const d = document.getElementById('reveal-defender').value;
        try {
          const c32 = c.startsWith('0x') ? c : '0x' + c.padStart(64, '0');
          const d32 = d.startsWith('0x') ? d : '0x' + d.padStart(64, '0');
          const tx = await contract.revealBattle(battleId, c32, d32);
          await tx.wait();
          showMsg('battle-msg', 'Battle resolved.', 'ok');
          refreshStats();
        } catch (e) { showMsg('battle-msg', e.shortMessage || e.message, 'err'); }
      });

      document.getElementById('btn-stratagem').addEventListener('click', async () => {
        if (!contract || !signer) { showMsg('strat-msg', 'Connect wallet and set contract.', 'err'); return; }
        hideMsg('strat-msg');
        const territoryId = document.getElementById('strat-territory').value;
